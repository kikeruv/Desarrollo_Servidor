<h2>Chat en línea</h2>

<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #222;
    color: white;
    text-align: center;
    margin: 0;
    padding: 20px;
  }

  #auth, #salas, #chat {
    background: #333;
    padding: 15px;
    margin: 10px auto;
    border-radius: 5px;
    width: 90%;
    max-width: 400px;
  }

  input[type="text"] {
    width: 90%;
    padding: 8px;
    margin: 8px 0;
    border: none;
    border-radius: 3px;
  }

  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    margin: 5px;
    border-radius: 3px;
    cursor: pointer;
  }

  button:hover {
    background: #0056b3;
  }

  #mensajes {
    background: #111;
    border: 1px solid #444;
    border-radius: 4px;
    height: 200px;
    overflow-y: auto;
    text-align: left;
    padding: 10px;
  }

  .msg {
    margin: 5px 0;
    padding: 5px 8px;
    border-radius: 4px;
  }

  .msg.me {
    background: #007bff;
    color: white;
    text-align: right;
  }

  .msg.other {
    background: #444;
  }

  .system {
    text-align: center;
    font-size: 12px;
    color: #bbb;
  }
</style>


<div id="auth">
  <label>Nombre:</label>
  <input type="text" id="nombre" placeholder="Escribe tu nombre" />
  <button id="entrar">Entrar</button>
  <button id="logout" style="display:none;">Cerrar sesión</button>
</div>

<div id="salas" style="display:none;">
  <h3>Salas disponibles</h3>
  <button class="sala" data-sala="general">#general</button>
  <button class="sala" data-sala="javascript">#javascript</button>
  <button class="sala" data-sala="offtopic">#offtopic</button>
</div>

<div id="chat" style="display:none;">
  <h3 id="tituloSala"></h3>
  <div id="mensajes"></div>
  <input type="text" id="mensaje" placeholder="Escribe tu mensaje" />
  <button id="enviar">Enviar</button>
  <button id="salir">Salir</button>
</div>

<script>
  const socket = io('/');
  const nombreInput = document.getElementById('nombre');
  const entrarBtn = document.getElementById('entrar');
  const logoutBtn = document.getElementById('logout');
  const salasDiv = document.getElementById('salas');
  const chatDiv = document.getElementById('chat');
  const tituloSala = document.getElementById('tituloSala');
  const mensajesDiv = document.getElementById('mensajes');
  const enviarBtn = document.getElementById('enviar');
  const salirBtn = document.getElementById('salir');
  const mensajeInput = document.getElementById('mensaje');

  let nombre = sessionStorage.getItem('nombre') || '';
  let salaActual = null;

  if (nombre) {
    socket.emit('register', nombre);
    mostrarSalas();
  }

  entrarBtn.addEventListener('click', () => {
    nombre = nombreInput.value.trim();
    if (!nombre) return alert('Debes escribir un nombre');
    sessionStorage.setItem('nombre', nombre);
    socket.emit('register', nombre);
    mostrarSalas();
  });

  logoutBtn.addEventListener('click', () => {
    socket.emit('logout');
    sessionStorage.removeItem('nombre');
    nombre = '';
    salaActual = null;
    ocultarTodo();
  });

  document.querySelectorAll('.sala').forEach(btn => {
    btn.addEventListener('click', () => {
      salaActual = btn.dataset.sala;
      socket.emit('join', salaActual);
      tituloSala.textContent = `Sala: ${salaActual}`;
      chatDiv.style.display = 'block';
      mensajesDiv.innerHTML = '';
    });
  });

  salirBtn.addEventListener('click', () => {
    socket.emit('leave');
    salaActual = null;
    chatDiv.style.display = 'none';
  });

  enviarBtn.addEventListener('click', () => {
  const texto = mensajeInput.value.trim();
  if (!texto) return;
  socket.emit('message', texto);
  mensajeInput.value = '';
  });


  socket.on('message', (msg) => {
    renderMensaje(msg, msg.from === nombre);
  });

  socket.on('system', (evt) => {
    const p = document.createElement('div');
    p.className = 'system';
    p.textContent = `[${new Date(evt.ts).toLocaleTimeString()}] ${evt.text}`;
    mensajesDiv.appendChild(p);
    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
  });

  function renderMensaje(msg, mio) {
    const div = document.createElement('div');
    div.className = `msg ${mio ? 'me' : 'other'}`;
    const hora = new Date(msg.ts).toLocaleTimeString();
    div.innerHTML = mio
      ? `${msg.text}<small>${hora}</small>`
      : `<strong>${msg.from}</strong>: ${msg.text}<small>${hora}</small>`;
    mensajesDiv.appendChild(div);
    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
  }

  function mostrarSalas() {
    document.getElementById('auth').style.display = 'none';
    salasDiv.style.display = 'block';
    logoutBtn.style.display = 'inline-block';
  }

  function ocultarTodo() {
    document.getElementById('auth').style.display = 'block';
    salasDiv.style.display = 'none';
    chatDiv.style.display = 'none';
    logoutBtn.style.display = 'none';
  }
</script>
