<h2>Chat en línea</h2>

<style>
  :root {
    --bg: #0f172a;
    --bg-card: #1e293b;
    --bg-input: #334155;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --border: #475569;
    --radius: 12px;
  }

  body {
    font-family: "Inter", system-ui, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #auth, #salas, #chat {
    background-color: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
    padding: 20px;
    width: 90%;
    max-width: 550px;
    margin-bottom: 20px;
    animation: fadeIn 0.5s ease;
  }

  h2, h3 {
    text-align: center;
    margin-top: 0;
    color: var(--accent);
  }

  input[type="text"] {
    width: calc(100% - 20px);
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px;
    color: var(--text);
    font-size: 15px;
    outline: none;
    margin-bottom: 10px;
  }

  input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 5px var(--accent);
  }

  button {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius);
    padding: 10px 16px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover {
    background: var(--accent-hover);
  }

  button#logout, button#salir {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  button#logout:hover, button#salir:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .sala {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 12px;
    margin: 4px;
    transition: 0.2s;
  }

  .sala:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  #mensajes {
    background: #0b1120;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    height: 300px;
    overflow-y: auto;
    padding: 12px;
    margin-bottom: 10px;
    scroll-behavior: smooth;
  }

  #mensajes p {
    margin: 6px 0;
    line-height: 1.4;
    word-wrap: break-word;
  }

  #mensajes p strong {
    color: var(--accent);
  }

  .msg {
    display: inline-block;
    padding: 8px 12px;
    border-radius: var(--radius);
    max-width: 80%;
    margin-bottom: 8px;
  }

  .msg.me {
    background: var(--accent);
    color: white;
    margin-left: auto;
    text-align: right;
    display: block;
  }

  .msg.other {
    background: var(--bg-input);
    color: var(--text);
    display: block;
    text-align: left;
  }

  .msg small {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .system {
    text-align: center;
    font-size: 13px;
    color: var(--text-muted);
    margin: 4px 0;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  #mensajes::-webkit-scrollbar {
    width: 8px;
  }
  #mensajes::-webkit-scrollbar-thumb {
    background-color: var(--border);
    border-radius: 8px;
  }
  #mensajes::-webkit-scrollbar-thumb:hover {
    background-color: var(--accent);
  }

  @media (max-width: 600px) {
    body { padding: 20px; }
    #auth, #salas, #chat { width: 100%; }
  }
</style>

<div id="auth">
  <label>Nombre:</label>
  <input type="text" id="nombre" placeholder="Escribe tu nombre" />
  <button id="entrar">Entrar</button>
  <button id="logout" style="display:none;">Cerrar sesión</button>
</div>

<div id="salas" style="display:none;">
  <h3>Salas disponibles</h3>
  <button class="sala" data-sala="general">#general</button>
  <button class="sala" data-sala="javascript">#javascript</button>
  <button class="sala" data-sala="offtopic">#offtopic</button>
</div>

<div id="chat" style="display:none;">
  <h3 id="tituloSala"></h3>
  <div id="mensajes"></div>
  <input type="text" id="mensaje" placeholder="Escribe tu mensaje" />
  <button id="enviar">Enviar</button>
  <button id="salir">Salir</button>
</div>

<script>
  const socket = io('/');
  const nombreInput = document.getElementById('nombre');
  const entrarBtn = document.getElementById('entrar');
  const logoutBtn = document.getElementById('logout');
  const salasDiv = document.getElementById('salas');
  const chatDiv = document.getElementById('chat');
  const tituloSala = document.getElementById('tituloSala');
  const mensajesDiv = document.getElementById('mensajes');
  const enviarBtn = document.getElementById('enviar');
  const salirBtn = document.getElementById('salir');
  const mensajeInput = document.getElementById('mensaje');

  let nombre = sessionStorage.getItem('nombre') || '';
  let salaActual = null;

  if (nombre) {
    socket.emit('register', nombre);
    mostrarSalas();
  }

  entrarBtn.addEventListener('click', () => {
    nombre = nombreInput.value.trim();
    if (!nombre) return alert('Debes escribir un nombre');
    sessionStorage.setItem('nombre', nombre);
    socket.emit('register', nombre);
    mostrarSalas();
  });

  logoutBtn.addEventListener('click', () => {
    socket.emit('logout');
    sessionStorage.removeItem('nombre');
    nombre = '';
    salaActual = null;
    ocultarTodo();
  });

  document.querySelectorAll('.sala').forEach(btn => {
    btn.addEventListener('click', () => {
      salaActual = btn.dataset.sala;
      socket.emit('join', salaActual);
      tituloSala.textContent = `Sala: ${salaActual}`;
      chatDiv.style.display = 'block';
      mensajesDiv.innerHTML = '';
    });
  });

  salirBtn.addEventListener('click', () => {
    socket.emit('leave');
    salaActual = null;
    chatDiv.style.display = 'none';
  });

  enviarBtn.addEventListener('click', () => {
  const texto = mensajeInput.value.trim();
  if (!texto) return;
  socket.emit('message', texto);
  mensajeInput.value = '';
  });


  socket.on('message', (msg) => {
    renderMensaje(msg, msg.from === nombre);
  });

  socket.on('system', (evt) => {
    const p = document.createElement('div');
    p.className = 'system';
    p.textContent = `[${new Date(evt.ts).toLocaleTimeString()}] ${evt.text}`;
    mensajesDiv.appendChild(p);
    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
  });

  function renderMensaje(msg, mio) {
    const div = document.createElement('div');
    div.className = `msg ${mio ? 'me' : 'other'}`;
    const hora = new Date(msg.ts).toLocaleTimeString();
    div.innerHTML = mio
      ? `${msg.text}<small>${hora}</small>`
      : `<strong>${msg.from}</strong>: ${msg.text}<small>${hora}</small>`;
    mensajesDiv.appendChild(div);
    mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
  }

  function mostrarSalas() {
    document.getElementById('auth').style.display = 'none';
    salasDiv.style.display = 'block';
    logoutBtn.style.display = 'inline-block';
  }

  function ocultarTodo() {
    document.getElementById('auth').style.display = 'block';
    salasDiv.style.display = 'none';
    chatDiv.style.display = 'none';
    logoutBtn.style.display = 'none';
  }
</script>
